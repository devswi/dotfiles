export ZSH="$HOME/.oh-my-zsh"

fpath+=("$(brew --prefix)/share/zsh/site-functions")

autoload -U promptinit; promptinit
prompt pure

plugins=(
  git
  brew
  node
  pnpm
  colored-man-pages
  colorize
  kubectl
  tmux
  zsh-autosuggestions
  zsh-syntax-highlighting
)

source $ZSH/oh-my-zsh.sh

# Alias
alias ll='ls -al'
alias la='ls -a'

alias vim='nvim'
alias vi='nvim'

export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

[ -f $HOMEBREW_PREFIX/etc/profile.d/autojump.sh ] && . $HOMEBREW_PREFIX/etc/profile.d/autojump.sh

# Go proxy
export GOPROXY=https://goproxy.cn

# fzf
eval "$(fzf --zsh)"

# kitty ssh fix
[[ "$TERM" == "xterm-kitty" ]] && alias ssh="TERM=xterm-256color ssh"

# Kubectl
source <(kubectl completion zsh)

# Android
## Java
export JAVA_HOME=/Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home
export ANDROID_HOME=$HOME/Library/Android/sdk
export PATH=$PATH:$ANDROID_HOME/emulator
export PATH=$PATH:$ANDROID_HOME/platform-tools

# Rust
export PATH=$PATH:$HOME/.cargo/bin

# Ruby
export PATH="$HOME/.rbenv/bin:$PATH"

# FZF
export FZF_DEFAULT_OPTS=" \
--color=bg+:#363a4f,bg:#24273a,spinner:#f4dbd6,hl:#ed8796 \
--color=fg:#cad3f5,header:#ed8796,info:#c6a0f6,pointer:#f4dbd6 \
--color=marker:#b7bdf8,fg+:#cad3f5,prompt:#c6a0f6,hl+:#ed8796 \
--color=selected-bg:#494d64 \
--multi"

# Proxy helpers (HTTP/HTTPS + ALL/SOCKS)
# Default proxy addresses; change if you use different host/port.
PROXY_HTTP_URL="http://127.0.0.1:7897"
PROXY_SOCKS_URL="socks5://127.0.0.1:7897"

# Enable proxy (exports both lowercase and uppercase variants and a basic no_proxy)
proxy_on() {
  export http_proxy="$PROXY_HTTP_URL"
  export https_proxy="$PROXY_HTTP_URL"
  export all_proxy="$PROXY_SOCKS_URL"

  # Uppercase variants for programs that look for them
  export HTTP_PROXY="$http_proxy"
  export HTTPS_PROXY="$https_proxy"
  export ALL_PROXY="$all_proxy"

  # Common local addresses to bypass the proxy
  export no_proxy="localhost,127.0.0.1,::1"
  echo "Proxy enabled: $http_proxy (HTTP/HTTPS), $all_proxy (ALL)"
}

# Disable proxy
proxy_off() {
  unset http_proxy https_proxy all_proxy HTTP_PROXY HTTPS_PROXY ALL_PROXY no_proxy
  echo "Proxy disabled"
}

# Print proxy status
proxy_status() {
  printf "http_proxy=%s\nhttps_proxy=%s\nall_proxy=%s\n" "${http_proxy:-<unset>}" "${https_proxy:-<unset>}" "${all_proxy:-<unset>}"
}

# Toggle proxy (on if currently off, off if currently on)
proxy_toggle() {
  if [ -n "${http_proxy-}" ]; then
    proxy_off
  else
    proxy_on
  fi
}

# Convenience aliases
alias proxy-enable='proxy_on'
alias proxy-disable='proxy_off'
alias proxy-toggle='proxy_toggle'

# Auto-enable proxy on shell startup
# Ways to enable by default:
# 1) set environment variable PROXY_AUTO=1 (e.g. export PROXY_AUTO=1 in your environment)
# 2) create a file $HOME/.proxy_on
# 3) set PROXY_AUTO_HOSTS to a space-separated list of hostnames and if current hostname
#    is in that list the proxy will be enabled automatically.
# To avoid printing the enable message, set PROXY_AUTO_QUIET=1.
PROXY_AUTO=${PROXY_AUTO:-0}
PROXY_AUTO_HOSTS=${PROXY_AUTO_HOSTS:-}
PROXY_AUTO_QUIET=${PROXY_AUTO_QUIET:-0}

_should_auto_enable_proxy() {
  # 1) env flag
  if [ "$PROXY_AUTO" = "1" ]; then
    return 0
  fi

  # 2) presence of toggle file
  if [ -f "$HOME/.proxy_on" ]; then
    return 0
  fi

  # 3) hostname match
  if [ -n "$PROXY_AUTO_HOSTS" ]; then
    # Surround with spaces to avoid partial matches
    if [[ " $PROXY_AUTO_HOSTS " == *" $(hostname) "* ]]; then
      return 0
    fi
  fi

  return 1
}

if _should_auto_enable_proxy; then
  if [ "$PROXY_AUTO_QUIET" = "1" ]; then
    proxy_on >/dev/null 2>&1
  else
    proxy_on
  fi
fi
export https_proxy=http://127.0.0.1:7897 http_proxy=http://127.0.0.1:7897 all_proxy=socks5://127.0.0.1:7897
# asdf
export PATH="${ASDF_DATA_DIR:-$HOME/.asdf}/shims:$PATH"

# zsh vi
bindkey -v
# The following lines have been added by Docker Desktop to enable Docker CLI completions.
fpath=(/Users/shiwei/.docker/completions $fpath)
autoload -Uz compinit
compinit
# End of Docker CLI completions

# go bin
ASDF_DIR="${ASDF_DIR:-${ASDF_DATA_DIR:-$HOME/.asdf}}"
if [ -f "$ASDF_DIR/asdf.sh" ] || command -v asdf >/dev/null 2>&1; then
  export GOPATH="$(asdf where golang)/packages"
  export GOROOT="$(asdf where golang)/go"
fi
export PATH=$PATH:$(go env GOBIN)
export PATH=$PATH:$(go env GOPATH)/bin

. "$HOME/.local/bin/env"

# bun completions
[ -s "/Users/shiwei/.bun/_bun" ] && source "/Users/shiwei/.bun/_bun"

# bun
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"

# 自动启用代理
export PROXY_AUTO=1
export PROXY_AUTO_QUIET=1
